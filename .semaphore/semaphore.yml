version: v1.0
name: Docker
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
auto_cancel:
  running:
    when: "true"
blocks:
  - name: Build & Push
    task:
      jobs:
        - name: install sentry
          commands:
            # Install the cli
            - curl -sL https://sentry.io/get-cli/ | SENTRY_CLI_VERSION="2.2.0" bash
            # From internal integration: Semaphore Release Integration
            - VERSION=$(sentry-cli releases propose-version)
            # Workflow to create releases
            - sentry-cli releases new "$VERSION"
            - sentry-cli releases set-commits "$VERSION" --auto
            - sentry-cli releases finalize "$VERSION"
        - name: docker build
          commands:
            - checkout
            - echo $DOCKER_HUB_ACCESS_TOKEN | docker login --username "$DOCKERHUB_USERNAME" --password-stdin
            - "docker build --tag=$DOCKERHUB_USERNAME/$IMAGE_NAME:latest --tag=$DOCKERHUB_USERNAME/$IMAGE_NAME:$(date +%Y%m%d-%H%M) ."
            - "docker push $DOCKERHUB_USERNAME/$IMAGE_NAME:latest"
      secrets:
        - name: Rosak
        - name: SentryAuth
      env_vars:
        - name: ENVIRONMENT
          value: prod
        - name: IMAGE_NAME
          value: rosak_backend
        - name: SENTRY_ORG
          value: kwongtn
        - name: SENTRY_PROJECT
          value: python-django
    run:
      when: branch = 'main'
